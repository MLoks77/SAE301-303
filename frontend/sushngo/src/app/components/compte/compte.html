<app-navbar></app-navbar>

<!-- front : maxime derènes -->

<div class="w-full h-10 mt-14 sm:mt-0 bg-black flex items-center pl-4 gap-1">
    <a routerLink="/accueil"
        class="relative text-gray-200 font-semibold hover:text-white border-b-2 border-transparent hover:border-white transition-colors duration-300">Accueil</a>
    <span class="text-white italic mb-1"> &gt; Compte</span>
</div>

<!-- ordinateur -->
<section id="fidelite" class="relative w-full overflow-hidden bg-[#879358]/10 py-10">
    <div class="absolute inset-0 bg-[#879358]/10 pointer-events-none"></div>

    <div class="relative z-10 mx-auto max-w-[1200px] px-4">
        <div class="grid grid-cols-2 gap-6 md:gap-8 lg:grid-cols-4">

            <div class="flex flex-col items-center w-full">
                <div class="relative aspect-square w-full max-w-[140px] sm:max-w-[180px] lg:max-w-[220px]">
                    <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-md">
                        <circle cx="100" cy="100" r="85" [attr.fill]="getStepColor(25)"
                            [attr.stroke]="getStepStrokeColor(25)" stroke-width="6"
                            class="transition-all duration-300" />
                        <text x="100" y="85" font-size="38" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(25)">25pts</text>
                        <text x="100" y="125" font-size="28" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(25)">-5%</text>
                    </svg>
                </div>
            </div>

            <div class="flex flex-col items-center w-full">
                <div class="relative aspect-square w-full max-w-[140px] sm:max-w-[180px] lg:max-w-[220px]">
                    <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-md">
                        <circle cx="100" cy="100" r="85" [attr.fill]="getStepColor(50)"
                            [attr.stroke]="getStepStrokeColor(50)" stroke-width="6" />
                        <text x="100" y="85" font-size="38" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(50)">50pts</text>
                        <text x="100" y="125" font-size="28" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(50)">-10%</text>
                    </svg>
                </div>
            </div>

            <div class="flex flex-col items-center w-full">
                <div class="relative aspect-square w-full max-w-[140px] sm:max-w-[180px] lg:max-w-[220px]">
                    <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-md">
                        <circle cx="100" cy="100" r="85" [attr.fill]="getStepColor(75)"
                            [attr.stroke]="getStepStrokeColor(75)" stroke-width="6" />
                        <text x="100" y="85" font-size="38" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(75)">75pts</text>
                        <text x="100" y="125" font-size="28" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(75)">-15%</text>
                    </svg>
                </div>
            </div>

            <div class="flex flex-col items-center w-full">
                <div class="relative aspect-square w-full max-w-[140px] sm:max-w-[180px] lg:max-w-[220px]">
                    <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-md">
                        <circle cx="100" cy="100" r="85" [attr.fill]="getStepColor(100)"
                            [attr.stroke]="getStepStrokeColor(100)" stroke-width="6" />
                        <text x="100" y="85" font-size="38" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(100)">100pts</text>
                        <text x="100" y="125" font-size="28" font-weight="bold" text-anchor="middle"
                            dominant-baseline="central" [attr.fill]="getStepTextColor(100)">-20%</text>
                    </svg>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="flex flex-col items-center justify-center w-full">

    <div class="flex flex-col items-center w-full ">
        <div class="max-w-[1200px] w-full flex flex-col sm:flex-row items-center gap-2 mt-6 px-4 sm:px-8">
            <span class="font-bold text-lg">{{ fidelite }}pts</span>
            <progress class="w-full border-2 border-black" id="fideliteprogress" [value]="fideliteProgress" max="100"
                [class.progress-yellow]="hasReachedAnyStep()"></progress>
        </div>
    </div>
    <div class="max-w-[1200px] w-full text-left fid px-4 sm:px-8">
        <h1 class="text-[1.25rem] sm:text-[1.5rem] font-bold mt-2">Fidélité</h1>
        <p class="text-[1rem] sm:text-[1.5rem]">
            <span *ngIf="hasReachedAnyStep(); else noReduction">
                Réduction active : <span class="font-bold text-yellow-600">-{{ getCurrentReduction() }}%</span>
            </span>
            <ng-template #noReduction>
                Atteignez chaque palier pour gagner une réduction
            </ng-template>
        </p>
    </div>


    <!-- Paramètres du compte -->
    <section class="my-10 bg-gray-100 w-[90%] rounded-lg shadow-lg p-8">
        <div *ngIf="message" class=" mb-4 p-4 rounded-lg" [class.bg-green-100]="messageType === 'success'"
            [class.bg-red-100]="messageType === 'error'" [class.text-green-800]="messageType === 'success'"
            [class.text-red-800]="messageType === 'error'">
            <div class="flex justify-between items-center">
                <p class="font-semibold">{{ message }}</p>
                <button (click)="clearMessage()"
                    class="cursor-pointer text-lg font-bold hover:opacity-70">&times;</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <h1 class="col-span-full text-xl font-bold underline">Informations personnelles :</h1>

            <div class="flex flex-col">
                <label for="nom" class="font-semibold">Nom</label>
                <input type="text" id="nom" name="nom" [(ngModel)]="formData.nom" [disabled]="!isEditing"
                    class="p-2 rounded border border-gray-400" [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>

            <div class="flex flex-col">
                <label for="prenom" class="font-semibold">Prénom</label>
                <input type="text" id="prenom" name="prenom" [(ngModel)]="formData.prenom" [disabled]="!isEditing"
                    class="p-2 rounded border border-gray-400" [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>

            <div class="flex flex-col">
                <label for="email" class="font-semibold">Email</label>
                <input type="email" id="email" name="email" [(ngModel)]="formData.email" [disabled]="!isEditing"
                    class="p-2 rounded border border-gray-400" [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>

            <div class="flex flex-col md:col-span-2">
                <label for="adresse" class="font-semibold">Adresse</label>
                <input type="text" id="adresse" name="adresse" [(ngModel)]="formData.adresse" [disabled]="!isEditing"
                    class="p-2 rounded border border-gray-400" [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>

            <div class="flex flex-col">
                <label for="telephone" class="font-semibold">Téléphone</label>
                <input type="text" id="telephone" name="telephone" [(ngModel)]="formData.telephone"
                    [disabled]="!isEditing" class="p-2 rounded border border-gray-400"
                    [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>

            <!-- Changer de mot de passe -->

            <h1 class="col-span-full text-xl font-bold mt-4 underline">Changer de mot de passe :</h1>
            <div class="flex flex-col">
                <label for="mdpactuel" class="font-semibold">Mot de passe actuel</label>
                <input type="password" id="mdpactuel" name="mdpactuel" [(ngModel)]="formData.mdpactuel"
                    [disabled]="!isEditing" class="p-2 rounded border border-gray-400"
                    [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>
            <div class="flex flex-col">
                <label for="mdpnouveau" class="font-semibold">Nouveau mot de passe</label>
                <input type="password" id="mdpnouveau" name="mdpnouveau" [(ngModel)]="formData.mdpnouveau"
                    [disabled]="!isEditing" class="p-2 rounded border border-gray-400"
                    [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>
            <div class="flex flex-col">
                <label for="mdpnouveauconfirm" class="font-semibold">Confirmer le nouveau mot de passe</label>
                <input type="password" id="mdpnouveauconfirm" name="mdpnouveauconfirm"
                    [(ngModel)]="formData.mdpnouveauconfirm" [disabled]="!isEditing"
                    class="p-2 rounded border border-gray-400" [ngClass]="isEditing ? 'bg-white' : 'bg-gray-200'">
            </div>
            <div class="col-span-full flex justify-between items-center mt-6">
                <a routerLink="/mot-de-passe-oublie" class="text-sm text-blue-600 hover:underline">Mot de passe oublié
                    ?</a>
                <div class="flex gap-2">
                    <button *ngIf="!isEditing" (click)="toggleEdit()"
                        class="bg-black-600 text-black hover:text-white cursor-pointer px-4 py-2 rounded hover:bg-blue-700 transition-colors border border-gray-400 bg-white">Modifier</button>
                    <button *ngIf="isEditing" (click)="saveChanges()"
                        class="bg-black-600 text-black hover:text-white cursor-pointer px-4 py-2 rounded hover:bg-green-700 transition-colors border border-gray-400 bg-white">Enregistrer</button>
                    <button *ngIf="isEditing" (click)="toggleEdit()"
                        class="bg-black-600 text-black hover:text-white cursor-pointer px-4 py-2 rounded hover:bg-red-700 transition-colors border border-gray-400 bg-white">Annuler</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Historique des commandes, on fetch l'id utilisateur sur les commandes -->
    <section class="my-10 bg-gray-200 w-[90%] rounded-lg shadow-lg min-h-[400px] p-8">
        <h1 class="text-xl font-bold mb-4">Historique des commandes</h1>
        <div *ngIf="orders.length === 0" class="text-center text-gray-500 mt-10">
            <p>Aucune commande pour le moment.</p>
        </div>
        <div *ngIf="orders.length > 0" class="space-y-4">
            <div *ngFor="let order of orders; let i = index" class="bg-white rounded-lg p-4 shadow-md">
                <!-- maxime derènes : j'ai fix le numéro de commande, on le fait apparaître avec un simple index et i + 1 à chaque fois-->
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h2 class="font-bold text-lg">
                            Commande {{ i + 1 }}</h2>
                        <p class="text-sm text-gray-600">{{ order.date_commande | date:'dd/MM/yyyy à HH:mm' }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg">{{ order.prix_total.toFixed(2) }}€</p>
                        <p class="text-sm text-gray-600">{{ order.mode }}</p>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="font-semibold mb-1">Contenu :</p>
                    <ul *ngFor="let produit of getOrderProducts(order)"
                        class="list-disc list-inside text-sm text-gray-700">
                        <li>{{ produit }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

</section>

<app-footer></app-footer>